<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SCOAP Analyzer — Line Fix</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
  <style>
    body {
      font-family: Inter, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: auto;
    }
    h1 { margin-bottom: 0.5em; }
    .controls {
      margin: 15px 0;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin-left: 6px;
    }
    button:disabled {
      background: #999;
      cursor: not-allowed;
    }
    pre#output {
      font-family: "Courier New", monospace;
      font-size: 14px;
      background: #111;
      color: #0f0;
      white-space: pre-wrap;     /* ✅ preserve newlines */
      word-break: break-word;
      border-radius: 8px;
      padding: 16px;
      overflow-x: auto;
      overflow-y: auto;
      min-height: 400px;
      max-width: 100%;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>SCOAP Analyzer</h1>
    <p>Upload your <b>.v</b> file, then click <b>Run SCOAP</b>.</p>

    <div class="controls">
      <input id="fileInput" type="file" accept=".v">
      <button id="runButton" disabled>Run SCOAP</button>
      <button id="reloadButton" disabled>Reload Script</button>
    </div>

    <h2>Output:</h2>
    <pre id="output">Loading Pyodide...</pre>
  </div>

<script>
(async () => {
  const outputEl = document.getElementById("output");
  const fileInput = document.getElementById("fileInput");
  const runBtn = document.getElementById("runButton");
  const reloadBtn = document.getElementById("reloadButton");

  function show(text) {
    // ✅ Force real line breaks and safe HTML rendering
    outputEl.innerHTML = text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/\r?\n/g, "<br>"); // <-- FIX HERE
  }

  show("Loading Pyodide...");
  let pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.0/full/" });
  show("Pyodide loaded. Loading SCOAP.py...");

  async function loadScript() {
    try {
      const resp = await fetch("SCOAP.py");
      if (!resp.ok) throw new Error("Missing SCOAP.py in same folder");
      const code = await resp.text();
      pyodide.FS.writeFile("SCOAP.py", code);
      show("SCOAP.py loaded successfully!");
      runBtn.disabled = false;
      reloadBtn.disabled = false;
    } catch (e) {
      show("Error loading SCOAP.py: " + e);
    }
  }

  await loadScript();

  runBtn.addEventListener("click", async () => {
    if (!fileInput.files.length) {
      alert("Please select a .v file first.");
      return;
    }

    const vf = fileInput.files[0];
    const txt = await vf.text();
    pyodide.FS.writeFile("input.v", txt);

    show("Running SCOAP analysis...");
    runBtn.disabled = true;
    reloadBtn.disabled = true;

    let captured = "";
    const capture = { batched: s => { captured += s; } };
    pyodide.setStdout(capture);
    pyodide.setStderr(capture);

    const pyCmd = `
import sys, importlib, traceback
if '' not in sys.path: sys.path.insert(0, '')
if 'SCOAP' in sys.modules: del sys.modules['SCOAP']
try:
    import SCOAP
    importlib.reload(SCOAP)
    sys.argv = ['SCOAP.py', 'input.v']
    SCOAP.main()
except Exception:
    traceback.print_exc()
`;

    try {
      await pyodide.runPythonAsync(pyCmd);
      // ✅ Now we explicitly replace \n with <br> in output
      if (!captured.trim()) show("(no output)");
      else show(captured);
    } catch (err) {
      show("Runtime error: " + err);
    } finally {
      pyodide.setStdout({ batched: s => console.log(s) });
      pyodide.setStderr({ batched: s => console.error(s) });
      runBtn.disabled = false;
      reloadBtn.disabled = false;
    }
  });

  reloadBtn.addEventListener("click", async () => {
    runBtn.disabled = true;
    reloadBtn.disabled = true;
    await loadScript();
  });
})();
</script>
</body>
</html>
